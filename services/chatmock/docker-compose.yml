networks:
  dokploy-network:
    name: dokploy-network
    external: true

volumes:
  chatmock_data:

services:
  chatmock:
    build: .
    image: chatmock:latest
    container_name: chatmock
    command: ["serve"]
    environment:
      - CHATGPT_LOCAL_HOME=/data
      - PORT=${PORT:8000} # Container listening port (default 8000)
      - VERBOSE=${VERBOSE} # true|false to enable request/stream logs
      - CHATGPT_LOCAL_REASONING_EFFORT=${CHATGPT_LOCAL_REASONING_EFFORT:medium} # minimal|low|medium|high
      - CHATGPT_LOCAL_REASONING_SUMMARY=${CHATGPT_LOCAL_REASONING_SUMMARY:auto} # auto|concise|detailed|none
      - CHATGPT_LOCAL_REASONING_COMPAT=${CHATGPT_LOCAL_REASONING_COMPAT} # legacy|o3|think-tags|current
      - CHATGPT_LOCAL_DEBUG_MODEL=${CHATGPT_LOCAL_DEBUG_MODEL} # force model override (e.g., gpt-5)
      - CHATGPT_LOCAL_CLIENT_ID=${CHATGPT_LOCAL_CLIENT_ID} # OAuth client id override (rarely needed)
      - CHATGPT_LOCAL_EXPOSE_REASONING_MODELS=${CHATGPT_LOCAL_EXPOSE_REASONING_MODELS:false} # true|false to add reasoning model variants to /v1/models
      - CHATGPT_LOCAL_ENABLE_WEB_SEARCH=${CHATGPT_LOCAL_ENABLE_WEB_SEARCH:true} # true|false to enable default web search tool
      - PUID=${PUID}
      - PGID=${PGID}
      - UMASK=${UMASK}
      - TZ=${TZ}
    networks:
      - dokploy-network
    volumes:
      - chatmock_data:/data
      - ${CONFIG_DIR}/chatmock/prompt.md:/app/prompt.md:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:8000/health').status==200 else 1)\" "]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    labels:
      traefik.enable: true
      traefik.docker.network: dokploy-network
      traefik.http.routers.ai-chatmock-web.entrypoints: web
      traefik.http.routers.ai-chatmock-web.middlewares: redirect-to-https@file,local-network-ipallowlist@file
      traefik.http.routers.ai-chatmock-web.rule: Host(`chatmock.${DOMAIN}`)
      traefik.http.routers.ai-chatmock-web.service: ai-chatmock-web
      traefik.http.routers.ai-chatmock-websecure.middlewares: local-network-ipallowlist@file
      traefik.http.routers.ai-chatmock-websecure.entrypoints: websecure
      traefik.http.routers.ai-chatmock-websecure.rule: Host(`chatmock.${DOMAIN}`)
      traefik.http.routers.ai-chatmock-websecure.service: ai-chatmock-websecure
      traefik.http.routers.ai-chatmock-websecure.tls.certresolver: dns-cloudflare
      traefik.http.services.ai-chatmock-web.loadbalancer.server.port: 8000
      traefik.http.services.ai-chatmock-websecure.loadbalancer.server.port: 8000

  chatmock-login:
    image: chatmock:latest
    pull_policy: always
    profiles: ["login"]
    command: ["login"]
    environment:
      - CHATGPT_LOCAL_HOME=/data
      - CHATGPT_LOCAL_LOGIN_BIND=0.0.0.0
      - PUID=${PUID}
      - PGID=${PGID}
      - UMASK=${UMASK}
      - TZ=${TZ}
    networks:
      - dokploy-network
    volumes:
      - chatmock_data:/data
    restart: unless-stopped
