#!/bin/bash
# ntfy user setup script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -e

echo "Setting up ntfy users..."

# Function to check if user exists
user_exists() {
    ntfy user list | grep -q "^$1 "
}

{% if ntfy_admin_username %}
# Create admin user if it doesn't exist
if ! user_exists "{{ ntfy_admin_username }}"; then
    echo "Creating admin user: {{ ntfy_admin_username }}"
    {% if ntfy_admin_password %}
    echo "{{ ntfy_admin_password }}" | ntfy user add --role=admin "{{ ntfy_admin_username }}"
    {% else %}
    ntfy user add --role=admin "{{ ntfy_admin_username }}"
    {% endif %}
else
    echo "Admin user {{ ntfy_admin_username }} already exists"
    {% if ntfy_admin_password %}
    echo "Updating password for admin user: {{ ntfy_admin_username }}"
    echo "{{ ntfy_admin_password }}" | ntfy user change-pass "{{ ntfy_admin_username }}"
    {% endif %}
fi
{% endif %}

{% for user in ntfy_users %}
# Create user: {{ user.username }}
if ! user_exists "{{ user.username }}"; then
    echo "Creating user: {{ user.username }} (role: {{ user.role | default('user') }})"
    {% if user.password %}
    echo "{{ user.password }}" | ntfy user add --role={{ user.role | default('user') }} "{{ user.username }}"
    {% else %}
    ntfy user add --role={{ user.role | default('user') }} "{{ user.username }}"
    {% endif %}
else
    echo "User {{ user.username }} already exists"
    {% if user.password %}
    echo "Updating password for user: {{ user.username }}"
    echo "{{ user.password }}" | ntfy user change-pass "{{ user.username }}"
    {% endif %}
    # Update role if needed
    echo "Ensuring user {{ user.username }} has role: {{ user.role | default('user') }}"
    ntfy user change-role "{{ user.username }}" "{{ user.role | default('user') }}"
fi

{% endfor %}

echo "User setup completed!"
echo ""
echo "Current users:"
ntfy user list
