#!/bin/bash
# ntfy user setup script - runs on host PC
# Generated by Ansible - DO NOT EDIT MANUALLY

set -e

echo "Setting up ntfy users..."

# Find the ntfy container
CONTAINER_NAME=$(docker ps --format '{{ "{{.Names}}" }}' --filter "name=ntfy-1" | head -n 1)

if [ -z "$CONTAINER_NAME" ]; then
    echo "Error: Could not find ntfy container. Make sure it's running."
    echo "Looking for containers with 'ntfy-1' in the name..."
    docker ps --format "table {{ "{{.Names}}" }}\t{{ "{{.Image}}" }}\t{{ "{{.Status}}" }}" --filter "ancestor=binwiederhier/ntfy"
    exit 1
fi

echo "Found ntfy container: $CONTAINER_NAME"

# Function to check if user exists
user_exists() {
    docker exec "$CONTAINER_NAME" ntfy user list | grep -q "^$1 " 2>/dev/null
}

{% if ntfy_admin_username %}
# Create admin user if it doesn't exist
if ! user_exists "{{ ntfy_admin_username }}"; then
    echo "Creating admin user: {{ ntfy_admin_username }}"
    {% if ntfy_admin_password %}
    docker exec -i "$CONTAINER_NAME" sh -c "NTFY_PASSWORD='{{ ntfy_admin_password }}' ntfy user add --role=admin '{{ ntfy_admin_username }}'"
    {% else %}
    docker exec -it "$CONTAINER_NAME" ntfy user add --role=admin "{{ ntfy_admin_username }}"
    {% endif %}
else
    echo "Admin user {{ ntfy_admin_username }} already exists"
    {% if ntfy_admin_password %}
    echo "Updating password for admin user: {{ ntfy_admin_username }}"
    docker exec -i "$CONTAINER_NAME" sh -c "NTFY_PASSWORD='{{ ntfy_admin_password }}' ntfy user change-pass '{{ ntfy_admin_username }}'"
    {% endif %}
fi
{% endif %}

{% for user in ntfy_users %}
# Create user: {{ user.username }}
if ! user_exists "{{ user.username }}"; then
    echo "Creating user: {{ user.username }} (role: {{ user.role | default('user') }})"
    {% if user.password %}
    docker exec -i "$CONTAINER_NAME" sh -c "NTFY_PASSWORD='{{ user.password }}' ntfy user add --role={{ user.role | default('user') }} '{{ user.username }}'"
    {% else %}
    docker exec -it "$CONTAINER_NAME" ntfy user add --role={{ user.role | default('user') }} '{{ user.username }}'
    {% endif %}
else
    echo "User {{ user.username }} already exists"
    {% if user.password %}
    echo "Updating password for user: {{ user.username }}"
    docker exec -i "$CONTAINER_NAME" sh -c "NTFY_PASSWORD='{{ user.password }}' ntfy user change-pass '{{ user.username }}'"
    {% endif %}
    # Update role if needed
    echo "Ensuring user {{ user.username }} has role: {{ user.role | default('user') }}"
    docker exec "$CONTAINER_NAME" ntfy user change-role "{{ user.username }}" "{{ user.role | default('user') }}"
fi

{% endfor %}

echo "User setup completed!"
echo ""
echo "Current users:"
docker exec "$CONTAINER_NAME" ntfy user list
